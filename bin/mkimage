#!/usr/bin/env bash

echo "Defining locales"
ROOTFS=/opt/target/redist
IMG_FILE=${COOKIE}/cache/images/${COOKIE_BOARD}-${COOKIE_APP}.img
TOTAL_SIZE=256
BOOT_SIZE=32
ROOTFS_SIZE=$((${TOTAL_SIZE}-${BOOT_SIZE}))
LOOP_DEVICE=/dev/loop0

echo "Removing previous artifacts"
mountpoint -q /mnt/boot && umount /mnt/boot
mountpoint -q /mnt		&& umount /mnt
losetup -d ${LOOP_DEVICE}
[ -e ${IMG_FILE} ] && rm -f ${IMG_FILE}
[ -e ${LOOP_DEVICE}p1 ] && rm ${LOOP_DEVICE}p1
[ -e ${LOOP_DEVICE}p2 ] && rm ${LOOP_DEVICE}p2

echo "Creating redist rootfs"
mkredist

echo "Preparing image"
echo "  ... boot size: ${BOOT_SIZE}"
echo "  ... rootfs size: ${ROOTFS_SIZE}"
echo "  ... total size: ${TOTAL_SIZE}"

echo "Creating image file"
mkdir -p ${COOKIE}/cache/images
dd if=/dev/zero of=${IMG_FILE} bs=1M count=${TOTAL_SIZE}

echo "Bind with losetup"
losetup -P ${LOOP_DEVICE} ${IMG_FILE}

echo "Partitioning image file"
fdisk ${LOOP_DEVICE} > /dev/null 2>&1 <<EOF
o
n
p
1

+ ${BOOT_SIZE}M
t
c
n
p
2


t
2
83
w
EOF
fdisk -l ${LOOP_DEVICE}

echo "Loopback devices"
lsblk ${LOOP_DEVICE};

echo "Ensuring device nodes exists"
[ ! -e ${LOOP_DEVICE}p1 ] && mknod -m 660 ${LOOP_DEVICE}p1 b 259 0
[ ! -e ${LOOP_DEVICE}p2 ] && mknod -m 660 ${LOOP_DEVICE}p2 b 259 1

echo "Preparing BOOT partition"
mkdosfs -n BOOT -S 512 -s 16 -v ${LOOP_DEVICE}p1 > /dev/null

echo "Preparing ROOTFS partition"
mkfs.ext4 -O ^huge_file ${LOOP_DEVICE}p2 > /dev/null

echo "Mounting partitions"
mount -t ext4 ${LOOP_DEVICE}p2 /mnt || exit 1
mkdir /mnt/boot
mount -t vfat ${LOOP_DEVICE}p1 /mnt/boot || exit 1

echo "Syncing Data"
rsync -aHAXx ${ROOTFS}/ /mnt/

echo "Cleanup"
umount /mnt/boot
umount /mnt
losetup -d ${LOOP_DEVICE}
rm ${LOOP_DEVICE}p1
rm ${LOOP_DEVICE}p2
